import{G as e,j as t}from"./index-6c723d70.js";import{r as s}from"./vendor-d6555781.js";import{v as a,p as n,u as c,r,w as l,A as i}from"./ui-eef567c7.js";import"./firebase-fb364782.js";import"./i18n-8b62e3c8.js";const CheckIns=()=>{const{guestData:d,setGuestData:o}=s.useContext(e),[m,u]=s.useState({name:"",frequency:"hourly",timeOfDay:"18:00",contacts:"",graceMinutes:10}),[g,x]=s.useState(null),h=s.useMemo(()=>d.checkIns||[],[d.checkIns]),y=s.useMemo(()=>(d.checkInLogs||[]).slice().reverse(),[d.checkInLogs]);s.useEffect(()=>{const e=setInterval(()=>{o(e=>({...e,checkIns:(e.checkIns||[]).map(t=>{const s=Date.now();if(!t.nextDue)return t;let a={...t};s>=t.nextDue&&"overdue"!==t.status&&(a.status="overdue");const n=60*(t.graceMinutes??10)*1e3;if(s>=t.nextDue+n&&!t.lastEscalatedAt){const n={id:crypto.randomUUID(),scheduleId:t.id,type:"escalation",at:s,message:`Missed check-in: ${t.name}`},c=[...e.checkInLogs||[],n].slice(-200);"granted"===(null==Notification?void 0:Notification.permission)&&new Notification("Check-in escalation",{body:`${t.name} missed; notifying contacts`}),setTimeout(()=>o(e=>({...e,checkInLogs:c})),0),a.lastEscalatedAt=s}return a})}))},3e4);return()=>clearInterval(e)},[o]);const computeNextDue=e=>{const t=new Date;if("hourly"===e.frequency)return Date.now()+36e5;if("daily"===e.frequency){const[s,a]=(e.timeOfDay||"18:00").split(":").map(Number),n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),s,a,0,0);return n.getTime()<=t.getTime()&&n.setDate(n.getDate()+1),n.getTime()}if("weekly"===e.frequency){const[s,a]=(e.timeOfDay||"18:00").split(":").map(Number),n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),s,a,0,0);return n.setDate(n.getDate()+7),n.getTime()}return Date.now()+864e5};return t.jsx("div",{className:"max-w-3xl mx-auto p-6",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 space-y-4",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("h1",{className:"text-2xl font-bold flex items-center",children:[t.jsx(a,{className:"h-6 w-6 mr-2"}),"Check-in Scheduler"]})}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("input",{className:"w-full p-2 rounded bg-gray-50 dark:bg-gray-700",placeholder:"Schedule name",value:m.name,onChange:e=>u({...m,name:e.target.value})}),t.jsxs("select",{className:"w-full p-2 rounded bg-gray-50 dark:bg-gray-700",value:m.frequency,onChange:e=>u({...m,frequency:e.target.value}),children:[t.jsx("option",{value:"hourly",children:"Hourly"}),t.jsx("option",{value:"daily",children:"Daily"}),t.jsx("option",{value:"weekly",children:"Weekly"})]}),"hourly"!==m.frequency&&t.jsx("input",{className:"w-full p-2 rounded bg-gray-50 dark:bg-gray-700",placeholder:"Time of day (HH:MM)",value:m.timeOfDay,onChange:e=>u({...m,timeOfDay:e.target.value})}),t.jsx("input",{className:"w-full p-2 rounded bg-gray-50 dark:bg-gray-700",placeholder:"Contacts (comma separated)",value:m.contacts,onChange:e=>u({...m,contacts:e.target.value})}),t.jsx("input",{className:"w-full p-2 rounded bg-gray-50 dark:bg-gray-700",placeholder:"Grace minutes",type:"number",value:m.graceMinutes,onChange:e=>u({...m,graceMinutes:Number(e.target.value)})}),t.jsxs("button",{onClick:()=>{if(!m.name)return;const e=g||Math.random().toString(36).slice(2,10),t={id:e,...m};t.contacts=(m.contacts||"").split(",").map(e=>e.trim()).filter(Boolean),t.nextDue=computeNextDue(t);const s=g?h.map(s=>s.id===e?t:s):[t,...h];o(e=>({...e,checkIns:s})),u({name:"",frequency:"hourly",timeOfDay:"18:00",contacts:"",graceMinutes:10}),x(null)},className:"px-3 py-2 bg-primary-600 text-white rounded flex items-center",children:[t.jsx(n,{className:"h-4 w-4 mr-1"}),g?"Update":"Add"," Schedule"]})]}),t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold mb-2",children:"Schedules"}),t.jsxs("ul",{className:"space-y-2",children:[h.map(e=>t.jsxs("li",{className:"p-3 bg-gray-50 dark:bg-gray-700 rounded",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:e.name}),t.jsxs("div",{className:"text-xs text-gray-500",children:[e.frequency,"hourly"!==e.frequency?` at ${e.timeOfDay}`:""]}),e.contacts&&e.contacts.length>0&&t.jsxs("div",{className:"text-xs text-gray-500",children:["Contacts: ",e.contacts.join(", ")]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:()=>(e=>{u({name:e.name,frequency:e.frequency,timeOfDay:e.timeOfDay||"18:00",contacts:(e.contacts||[]).join(", "),graceMinutes:e.graceMinutes??10}),x(e.id)})(e),className:"px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-sm flex items-center",children:[t.jsx(c,{className:"h-4 w-4 mr-1"}),"Edit"]}),t.jsxs("button",{onClick:()=>{return t=e.id,void o(e=>({...e,checkIns:h.filter(e=>e.id!==t)}));var t},className:"px-2 py-1 bg-red-600 text-white rounded text-sm flex items-center",children:[t.jsx(r,{className:"h-4 w-4 mr-1"}),"Delete"]})]})]}),t.jsxs("div",{className:"mt-2 flex items-center justify-between text-sm",children:[t.jsxs("div",{children:["Next due: ",e.nextDue?new Date(e.nextDue).toLocaleString():"-"]}),t.jsx("div",{className:"text-xs px-2 py-0.5 rounded "+("overdue"===e.status?"bg-red-100 text-red-700":"bg-green-100 text-green-700"),children:e.status||"ok"})]}),t.jsx("div",{className:"mt-2",children:t.jsxs("button",{onClick:()=>{return t=e.id,void o(e=>({...e,checkIns:h.map(e=>e.id===t?{...e,status:"ok",lastCheckedInAt:Date.now(),nextDue:computeNextDue(e),lastEscalatedAt:null}:e)}));var t},className:"px-2 py-1 bg-green-600 text-white rounded text-sm flex items-center",children:[t.jsx(l,{className:"h-4 w-4 mr-1"}),"I am safe"]})})]},e.id)),0===h.length&&t.jsxs("li",{className:"text-gray-500 flex items-center",children:[t.jsx(i,{className:"h-4 w-4 mr-2"}),"No schedules yet"]})]})]})]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("div",{className:"font-semibold mb-2",children:"Escalation Log"}),t.jsxs("div",{className:"max-h-48 overflow-y-auto space-y-1",children:[y.map(e=>t.jsxs("div",{className:"text-sm p-2 bg-gray-50 dark:bg-gray-700 rounded",children:[new Date(e.at).toLocaleString()," â€” ",e.message]},e.id)),0===y.length&&t.jsx("div",{className:"text-gray-500 text-sm",children:"No escalations yet"})]})]})]})})};export{CheckIns as default};
