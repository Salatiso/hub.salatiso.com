import{G as e,j as t,i as s,a,o as n}from"./index-286a0f84.js";import{b as i,r,L as l}from"./vendor-c40a6ff5.js";import{t as o,e as d,p as c,a as m,b as p,s as u,n as h}from"./contactParsers-bcf98064.js";import"./firebase-fb364782.js";import"./i18n-53393985.js";import"./ui-ac866f5b.js";const StepHeader=({step:e,total:s,title:a})=>t.jsxs("div",{className:"mb-6",children:[t.jsxs("div",{className:"text-sm text-gray-500",children:["Step ",e," of ",s]}),t.jsx("h2",{className:"text-2xl font-semibold",children:a})]});function ContactImportWizard(){const x=i(),{guestData:v,setGuestData:j}=r.useContext(e),[f,y]=r.useState(1),[g,b]=r.useState("file"),[N,w]=r.useState(null),[C,k]=r.useState(""),[S,I]=r.useState([]),[P,A]=r.useState(""),[O,F]=r.useState([]),[U,$]=r.useState([]),[L,M]=r.useState({}),[q,B]=r.useState({}),E=r.useCallback(()=>y(e=>Math.min(6,e+1)),[6]),J=r.useCallback(()=>y(e=>Math.max(1,e-1)),[]),W=r.useCallback(()=>async function(e,t,s,a,n,i){try{if(!("contacts"in navigator)||!("select"in navigator.contacts))throw new Error("Contacts Picker API not supported on this device/browser.");const i=["name","email","tel","address"],r={multiple:!0},l=await navigator.contacts.select(i,r),o=(l||[]).map(e=>({name:{formatted:Array.isArray(e.name)?e.name[0]:e.name||""},emails:Array.isArray(e.email)?e.email.map(e=>({value:e})):e.email?[{value:e.email}]:[],phones:Array.isArray(e.tel)?e.tel.map(e=>({value:e})):e.tel?[{value:e.tel}]:[],addresses:[]})).map(h);e(o);t(u(o,a.profile||{})),s(o.map(e=>{var t;return{contactId:e.id||(null==(t=e.name)?void 0:t.formatted)||Math.random().toString(36).slice(2),type:"friend"}})),n(3)}catch(r){i(r.message)}}(I,F,$,v,y,A),[v]);const D=r.useMemo(()=>o(S,U.filter(e=>["parent","child","spouse","sibling"].includes(e.type)).map(e=>({fromId:"self",toId:e.contactId,type:e.type}))),[S,U]);return t.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[1===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:1,total:6,title:"Choose import method"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"radio",name:"method",checked:"file"===g,onChange:()=>b("file")})," File upload (.csv, .vcf, .json)"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"radio",name:"method",checked:"paste"===g,onChange:()=>b("paste")})," Paste JSON (converted via AI)"]}),t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"radio",name:"method",checked:"phone"===g,onChange:()=>b("phone")})," Pick from phone (where supported)"]})]}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx(l,{className:"text-gray-600",to:"/dashboard",children:"Cancel"}),t.jsx("button",{className:"btn btn-primary bg-primary-600 text-white px-4 py-2 rounded",onClick:()=>y(2),children:"Next"})]})]}),2===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:2,total:6,title:"Provide contacts"}),"file"===g?t.jsxs("div",{className:"space-y-4",children:[t.jsx("input",{type:"file",accept:".csv,.vcf,.vcard,.json",onChange:e=>{var t;return w((null==(t=e.target.files)?void 0:t[0])||null)}}),t.jsx("p",{className:"text-sm text-gray-600",children:"From phone/computer exports: iOS Contacts → Export vCard (.vcf) or CSV; Android/Google Contacts → Export CSV or vCard."})]}):"paste"===g?t.jsxs("div",{className:"space-y-3",children:[t.jsx("p",{className:"text-sm text-gray-700",children:"If your contacts are not already JSON, copy your CSV/VCF into an AI like ChatGPT or Gemini with this prompt, then paste the JSON below."}),t.jsx("textarea",{readOnly:!0,className:"w-full p-3 border rounded text-xs bg-gray-50",rows:8,value:d()}),t.jsx("textarea",{className:"w-full p-3 border rounded",rows:10,placeholder:"Paste converted JSON here",value:C,onChange:e=>k(e.target.value)})]}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("p",{className:"text-sm text-gray-700",children:"Use your device's contacts picker to select contacts. This requires a secure context (https) and a supported browser."}),t.jsx("button",{className:"px-4 py-2 bg-gray-200 rounded",onClick:W,children:"Pick contacts from phone"}),t.jsx("p",{className:"text-xs text-gray-500",children:"If the button doesn't work, use the File upload or Paste JSON methods."})]}),P&&t.jsx("div",{className:"mt-3 text-red-600",children:P}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx("button",{className:"px-3 py-2 rounded border",onClick:J,children:"Back"}),t.jsx("button",{className:"px-4 py-2 bg-primary-600 text-white rounded",onClick:async function(){A("");try{let e=[];if("file"===g&&N){const t=await N.text();if(N.name.toLowerCase().endsWith(".csv"))e=c(t);else if(N.name.toLowerCase().endsWith(".vcf")||N.name.toLowerCase().endsWith(".vcard"))e=m(t);else{if(!N.name.toLowerCase().endsWith(".json"))throw new Error("Unsupported file. Use .csv, .vcf, or .json");e=p(t)}}else if("paste"===g&&(e=p(C),!e.length))throw new Error("Could not parse pasted content. Ensure valid JSON per schema.");I(e),F(u(e,v.profile||{})),$(e.map(e=>{var t;return{contactId:e.id,type:(null==(t=O.find(t=>t.contactId===e.id))?void 0:t.suggestion)||"friend"}})),y(3)}catch(e){A(e.message)}},disabled:"phone"===g,children:"Parse"})]})]}),3===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:3,total:6,title:"Review and tag relationships"}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[60vh] overflow-auto",children:S.map(e=>{var s,a,n,i,r,l;return t.jsxs("div",{className:"border rounded p-3",children:[t.jsx("div",{className:"font-medium",children:(null==(s=e.name)?void 0:s.formatted)||"Unnamed"}),t.jsx("div",{className:"text-sm text-gray-600",children:(null==(n=null==(a=e.emails)?void 0:a[0])?void 0:n.value)||(null==(r=null==(i=e.phones)?void 0:i[0])?void 0:r.value)||""}),t.jsxs("div",{className:"mt-2",children:[t.jsx("label",{className:"text-sm text-gray-700",children:"Relationship"}),t.jsxs("select",{className:"mt-1 border rounded p-1 w-full",value:(null==(l=U.find(t=>t.contactId===e.id))?void 0:l.type)||"friend",onChange:t=>{return s=e.id,a=t.target.value,void $(e=>e.map(e=>e.contactId===s?{...e,type:a}:e));var s,a},children:[t.jsx("option",{value:"spouse",children:"Spouse"}),t.jsx("option",{value:"mother",children:"Mother"}),t.jsx("option",{value:"father",children:"Father"}),t.jsx("option",{value:"son",children:"Son"}),t.jsx("option",{value:"daughter",children:"Daughter"}),t.jsx("option",{value:"sibling",children:"Sibling"}),t.jsx("option",{value:"parent",children:"Parent"}),t.jsx("option",{value:"child",children:"Child"}),t.jsx("option",{value:"family",children:"Family (unspecified)"}),t.jsx("option",{value:"friend",children:"Friend"}),t.jsx("option",{value:"colleague",children:"Colleague"}),t.jsx("option",{value:"neighbor",children:"Neighbor"}),t.jsx("option",{value:"other",children:"Other"})]})]})]},e.id)})}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx("button",{className:"px-3 py-2 rounded border",onClick:J,children:"Back"}),t.jsx("button",{className:"px-4 py-2 bg-primary-600 text-white rounded",onClick:E,children:"Next"})]})]}),4===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:4,total:6,title:"Preview family tree"}),t.jsx(FamilyTreePreview,{tree:D}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx("button",{className:"px-3 py-2 rounded border",onClick:J,children:"Back"}),t.jsx("button",{className:"px-4 py-2 bg-primary-600 text-white rounded",onClick:E,children:"Next"})]})]}),5===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:5,total:6,title:"Select who to invite and what to share"}),t.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-auto",children:S.map(e=>{var s;return t.jsxs("div",{className:"border rounded p-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"font-medium",children:(null==(s=e.name)?void 0:s.formatted)||"Unnamed"}),t.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:!!L[e.id],onChange:()=>{return t=e.id,void M(e=>({...e,[t]:!e[t]}));var t}})," Invite"]})]}),L[e.id]&&t.jsx("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm",children:["name","address","phones","emails","work","education","clan"].map(s=>{var a;return t.jsxs("label",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:!!(null==(a=q[e.id])?void 0:a[s]),onChange:()=>function(e,t){B(s=>{var a;return{...s,[e]:{...s[e]||{},[t]:!(null==(a=s[e])?void 0:a[t])}}})}(e.id,s)})," Share ",s]},s)})})]},e.id)})}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx("button",{className:"px-3 py-2 rounded border",onClick:J,children:"Back"}),t.jsx("button",{className:"px-4 py-2 bg-primary-600 text-white rounded",onClick:E,children:"Next"})]})]}),6===f&&t.jsxs("div",{children:[t.jsx(StepHeader,{step:6,total:6,title:"Review and save"}),t.jsxs("ul",{className:"list-disc pl-6 text-gray-700",children:[t.jsxs("li",{children:[S.length," contacts parsed"]}),t.jsxs("li",{children:[U.length," relationship tags"]}),t.jsxs("li",{children:[Object.values(L).filter(Boolean).length," invites queued"]})]}),t.jsxs("div",{className:"mt-6 flex justify-between",children:[t.jsx("button",{className:"px-3 py-2 rounded border",onClick:J,children:"Back"}),t.jsx("button",{className:"px-4 py-2 bg-green-600 text-white rounded",onClick:async function(){const e=function(e,t){const s=new Map(e.map(e=>[contactKey(e),e]));for(const a of t){const e=contactKey(a);if(s.has(e)){const t=s.get(e);t.phones=mergeUnique(t.phones,a.phones,e=>e.value),t.emails=mergeUnique(t.emails,a.emails,e=>e.value),t.addresses=mergeUnique(t.addresses,a.addresses,e=>`${e.street}|${e.city}|${e.region}|${e.postalCode}|${e.country}`)}else s.set(e,a)}return Array.from(s.values())}(await s("contacts")||[],S);await a("contacts",e),await a("relationships",U),j(t=>({...t,contacts:e,relationships:U}));const t=Object.entries(L).filter(([,e])=>e).map(([e])=>({type:"invite",payload:{contactId:e,share:q[e]||{}}}));for(const s of t)await n(s);x("/family-tree")},children:"Save and view family tree"})]})]})]})}function contactKey(e){var t,s,a,n,i,r,l,o;return`${(null==(n=null==(a=null==(s=null==(t=e.emails)?void 0:t[0])?void 0:s.value)?void 0:a.toLowerCase)?void 0:n.call(a))||""}|${(null==(l=null==(r=null==(i=e.phones)?void 0:i[0])?void 0:r.value)?void 0:l.replace(/\D/g,""))||""}|${((null==(o=e.name)?void 0:o.formatted)||"").toLowerCase()}`}function mergeUnique(e=[],t=[],s){const a=new Map(e.map(e=>[s(e),e]));for(const n of t)a.set(s(n),n);return Array.from(a.values())}function FamilyTreePreview({tree:e}){return e&&e.nodes?t.jsxs("div",{className:"border rounded p-4",children:[t.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"Simple tree preview (Self at center)"}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[60vh] overflow-auto",children:e.nodes.map(e=>t.jsxs("div",{className:"p-3 border rounded",children:[t.jsx("div",{className:"font-medium",children:e.label}),t.jsx("div",{className:"text-xs text-gray-500",children:e.deceased?"Deceased":"Alive"})]},e.id))})]}):null}export{ContactImportWizard as default};
