import{n as e,q as t,v as s,j as a}from"./index-286a0f84.js";import{r}from"./vendor-c40a6ff5.js";import{A as l,aJ as i,a8 as n,a4 as o,p as c}from"./ui-ac866f5b.js";import"./firebase-fb364782.js";import"./i18n-53393985.js";const d=new class{async createProfile(t){try{const s=await e.profiles.add(t);await e.accounts.add(t.account);const a=[],r=await e.taskDefinitions.toArray();for(const e of r)a.push({taskId:e.id,profileId:t.id,isCompleted:!1,isVerified:!1});return await e.tasks.bulkAdd(a),s}catch(s){throw s}}async getProfile(t){try{const s=await e.profiles.get(t);if(s){const a=await e.tasks.where("profileId").equals(t).toArray();s.tasks=a}return s}catch(s){throw s}}async getAllProfiles(){try{const t=await e.profiles.toArray();for(const s of t){const t=await e.tasks.where("profileId").equals(s.id).toArray();s.tasks=t}return t}catch(t){throw t}}async getProfileByEmail(t){try{const s=await e.accounts.where("email").equals(t).first();if(!s)return;return this.getProfile(s.id)}catch(s){throw s}}async updateProfile(t){try{t.updatedAt=Date.now(),await e.transaction("rw",e.profiles,e.accounts,e.tasks,async()=>{await e.profiles.put(t),await e.accounts.put(t.account);for(const s of t.tasks)s.id&&await e.tasks.put(s)})}catch(s){throw s}}async deleteProfile(t){try{await e.transaction("rw",e.profiles,e.accounts,e.tasks,async()=>{const s=await e.profiles.get(t);s&&await e.accounts.delete(s.account.id),await e.tasks.where("profileId").equals(t).delete(),await e.profiles.delete(t)})}catch(s){throw s}}async updateTaskStatus(t){try{t.id&&await e.tasks.put(t);const s=await this.getProfile(t.profileId);s&&await this.updateProfile(s)}catch(s){throw s}}async completeTask(t,s,a){try{const r=await this.getProfile(t);if(!r)throw new Error("Profile not found");const l=r.tasks.find(e=>e.taskId===s);if(!l)throw new Error("Task not found");l.isCompleted=!0,l.completedAt=Date.now(),a&&(l.data=a),l.id&&await e.tasks.put(l),r.tasks=r.tasks.map(e=>e.taskId===s?l:e),r.trustScore=this.calculateTrustScore(r.tasks),r.updatedAt=Date.now(),await e.profiles.put(r)}catch(r){throw r}}calculateTrustScore(e){const t=e.filter(e=>e.isCompleted),s=e.filter(e=>e.isVerified),a=12.5*t.length,r=1.25*s.length,l=Math.min(100,Math.round(2*(a+r))/2);return{total:l,breakdown:{tasks:Math.round(a),verification:Math.round(r),security:0},level:l>=80?"trusted":l>=60?"verified":l>=30?"basic":"minimal",completedTasks:t.length,lastUpdated:Date.now()}}async getProfileStats(){try{const t=await e.profiles.toArray(),s=Date.now(),a=864e5,r=t.filter(e=>s-e.lastAccessedAt<a).length,l=t.filter(e=>e.tasks&&e.tasks.length>0).length,i=t.filter(e=>e.trustScore.total>=60).length;return{total:t.length,recent:r,withTasks:l,highTrust:i}}catch(t){throw t}}async searchProfiles(e){try{const t=await this.getAllProfiles(),s=e.toLowerCase();return t.filter(t=>t.account.name.toLowerCase().includes(s)||t.account.email&&t.account.email.toLowerCase().includes(s)||t.account.phone&&t.account.phone.includes(e))}catch(t){throw t}}async exportProfiles(){try{const e=await this.getAllProfiles(),t={version:"1.0",exportedAt:Date.now(),profileCount:e.length,profiles:e};return JSON.stringify(t,null,2)}catch(e){throw e}}async clearAllProfiles(){try{await e.clear()}catch(t){throw t}}},PinVerificationModal=({onVerified:e,onCancel:h})=>{const[u,m]=r.useState("profile-select"),[x,g]=r.useState([]),[f,p]=r.useState(null),[b,w]=r.useState(""),[y,j]=r.useState(!1),[N,v]=r.useState(0),[k,P]=r.useState(!1),[A,C]=r.useState(""),[S,I]=r.useState(!1),T=r.useCallback(async()=>{try{I(!0);const e=await d.getAllProfiles();g(e),I(!1),1===e.length&&(p(e[0]),m("pin-entry"))}catch(e){C("Failed to load profiles. Please refresh and try again."),I(!1)}},[]);r.useState(()=>{T()});const V=t(b),D="good"===V.strength?"bg-green-500":"fair"===V.strength?"bg-yellow-500":"bg-red-500",E=r.useCallback(async()=>{if(f&&f.account.pin)if(k)C("Account locked. Too many failed attempts.");else if(b.length<4)C("PIN must be at least 4 digits");else try{I(!0),C("");if(s(b,f.account.pin.hash,f.account.pin.salt)){const t={...f,lastLoginAt:Date.now()};await d.updateProfile(t),m("verified"),setTimeout(()=>{e(t)},1e3)}else{const e=N+1;v(e),e>=3?(P(!0),C("Account locked after 3 failed attempts. Try again in 15 minutes."),m("error")):(C(`PIN incorrect. ${3-e} attempts remaining.`),w(""))}}catch(t){C(`Verification failed: ${t instanceof Error?t.message:"Unknown error"}`),m("error")}finally{I(!1)}else C("Profile not configured correctly")},[f,b,N,k,e]),handleBackToProfiles=()=>{p(null),w(""),v(0),C(""),m("profile-select")};return"profile-select"===u?a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full p-6 max-h-96 overflow-y-auto",children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Select Account"}),S?a.jsx("div",{className:"flex justify-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):0===x.length?a.jsxs("div",{className:"text-center py-8",children:[a.jsx(l,{className:"w-12 h-12 text-yellow-500 mx-auto mb-3"}),a.jsx("p",{className:"text-gray-600",children:"No profiles found. Please migrate your account first."}),h&&a.jsx("button",{onClick:h,className:"mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:"Go Back"})]}):a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"space-y-3",children:x.map(e=>{var t;return a.jsxs("button",{onClick:()=>(e=>{p(e),w(""),v(0),P(!1),C(""),m("pin-entry")})(e),className:"w-full p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left",children:[a.jsx("div",{className:"font-semibold text-gray-900",children:e.account.name}),a.jsx("div",{className:"text-sm text-gray-500",children:e.account.email}),a.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Trust Score: ",(null==(t=e.trustScore)?void 0:t.total)||0,"/100"]})]},e.id)})}),h&&a.jsx("button",{onClick:h,className:"w-full mt-4 px-4 py-2 text-gray-600 hover:text-gray-900 transition",children:"Cancel"})]})]})}):"pin-entry"===u&&f?a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full p-6",children:[a.jsx("button",{onClick:handleBackToProfiles,className:"text-sm text-gray-500 hover:text-gray-700 mb-4 transition",children:"â† Change account"}),a.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Verify PIN"}),a.jsxs("p",{className:"text-gray-600 mb-6",children:["Enter your PIN for ",f.account.name]}),A&&a.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex gap-2",children:[a.jsx(l,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),a.jsx("p",{className:"text-sm text-red-700",children:A})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"PIN"}),a.jsxs("div",{className:"relative",children:[a.jsx("input",{type:y?"text":"password",value:b,onChange:e=>{const t=e.target.value.replace(/\D/g,"").slice(0,12);w(t),C("")},onKeyPress:e=>{"Enter"===e.key&&b.length>=4&&!S&&!k&&E()},placeholder:"Enter 4-12 digits",className:"w-full px-4 py-3 pr-10 border-2 rounded-lg font-mono text-lg tracking-widest focus:outline-none transition "+(A&&b.length>0?"border-red-500 focus:border-red-600":"border-gray-300 focus:border-blue-500"),disabled:S||k}),a.jsx("button",{onClick:()=>j(!y),className:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 transition",children:y?a.jsx(i,{className:"w-5 h-5"}):a.jsx(n,{className:"w-5 h-5"})})]})]}),b.length>0&&a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Strength"}),a.jsx("span",{className:"text-sm font-semibold "+("good"===V.strength?"text-green-600":"fair"===V.strength?"text-yellow-600":"text-red-600"),children:V.strength.charAt(0).toUpperCase()+V.strength.slice(1)})]}),a.jsx("div",{className:"w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full ${D} transition-all`,style:{width:b.length/12*100+"%"}})}),a.jsx("p",{className:"text-xs text-gray-500 mt-1",children:V.message})]}),N>0&&a.jsxs("div",{className:"mb-4 text-sm text-gray-600",children:["Attempts: ",N,"/3"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("button",{onClick:E,disabled:b.length<4||S||k,className:"w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 "+(b.length<4||S||k?"bg-gray-200 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:S?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Verifying..."]}):a.jsxs(a.Fragment,{children:["Verify PIN",a.jsx(o,{className:"w-4 h-4"})]})}),a.jsx("button",{onClick:handleBackToProfiles,className:"w-full py-3 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 transition",disabled:S,children:"Cancel"})]}),a.jsx("button",{className:"w-full mt-4 text-sm text-blue-600 hover:text-blue-700 transition",children:"Forgot PIN?"})]})}):"verified"===u?a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full p-6 text-center",children:[a.jsx("div",{className:"mb-4 flex justify-center",children:a.jsxs("div",{className:"relative w-16 h-16",children:[a.jsx("div",{className:"absolute inset-0 bg-green-100 rounded-full animate-pulse"}),a.jsx(c,{className:"w-16 h-16 text-green-600 relative z-10"})]})}),a.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"PIN Verified!"}),a.jsxs("p",{className:"text-gray-600",children:["Welcome back, ",null==f?void 0:f.account.name]})]})}):"error"===u?a.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full p-6",children:[a.jsx("div",{className:"mb-4 flex justify-center",children:a.jsx(l,{className:"w-16 h-16 text-red-600"})}),a.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2 text-center",children:"Verification Failed"}),a.jsx("p",{className:"text-gray-600 text-center mb-6",children:A}),a.jsxs("div",{className:"space-y-2",children:[!k&&a.jsx("button",{onClick:()=>{w(""),C(""),m("pin-entry")},className:"w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold",children:"Try Again"}),a.jsx("button",{onClick:handleBackToProfiles,className:"w-full py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition font-semibold",children:k?"Exit":"Back to Accounts"})]})]})}):null},PinVerificationTest=()=>{var e,t;const[s,l]=r.useState(!0),[i,n]=r.useState(null);return i?a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:a.jsxs("div",{className:"max-w-md bg-white rounded-lg shadow-lg p-8 text-center",children:[a.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-4",children:"Welcome!"}),a.jsxs("p",{className:"text-gray-600 mb-6",children:["You have successfully logged in as ",a.jsx("strong",{children:i.account.name})]}),a.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6",children:[a.jsxs("p",{className:"text-sm text-gray-600",children:[a.jsx("strong",{children:"Email:"})," ",i.account.email]}),a.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[a.jsx("strong",{children:"Trust Score:"})," ",(null==(e=i.trustScore)?void 0:e.total)||0,"/100"]}),a.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:[a.jsx("strong",{children:"Tasks Completed:"})," ",(null==(t=i.trustScore)?void 0:t.completedTasks)||0,"/8"]})]}),a.jsx("button",{onClick:()=>{n(null),l(!0)},className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold",children:"Logout & Try Another PIN"})]})}):a.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:s?a.jsxs(a.Fragment,{children:[a.jsx(PinVerificationModal,{onVerified:e=>{n(e),l(!1)},onCancel:()=>{l(!1)}}),a.jsx("div",{className:"absolute inset-0 flex items-end justify-center p-4 pointer-events-none",children:a.jsxs("div",{className:"pointer-events-auto bg-white rounded-lg p-4 max-w-md text-sm text-gray-600 shadow-lg",children:[a.jsx("p",{className:"font-semibold text-gray-900 mb-2",children:"ðŸ“ Test Instructions:"}),a.jsxs("ul",{className:"space-y-1 text-xs",children:[a.jsx("li",{children:"1. Navigate to /test-migration-data to add test profiles"}),a.jsx("li",{children:"2. Migrated profiles will appear in this modal"}),a.jsx("li",{children:"3. Test PINs: 1234 (John) or 5678 (Jane)"}),a.jsx("li",{children:"4. Invalid PIN shows attempts counter (locked after 3)"})]})]})})]}):a.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 text-center max-w-md",children:[a.jsx("p",{className:"text-gray-600 mb-4",children:"Modal closed - verify with another PIN to see the verified state"}),a.jsx("button",{onClick:()=>l(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:"Open Modal Again"})]})})};export{PinVerificationTest as default};
