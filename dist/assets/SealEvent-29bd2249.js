import{G as e,j as t,o as a}from"./index-cd94da5a.js";import{d as s,r as n,L as i}from"./vendor-d6555781.js";import{b as l}from"./browser-0b5c6963.js";import{A as r,b as d,o as c,U as o,p as m,q as x,X as v,r as u,s as h,t as p}from"./ui-eef567c7.js";import"./firebase-fb364782.js";import"./i18n-8b62e3c8.js";const SealEvent=()=>{var g,y;const{id:j}=s(),{guestData:b,setGuestData:N}=n.useContext(e),[f,w]=n.useState(!1),[k,S]=n.useState({name:"",contact:""}),E=n.useRef(null),[D,C]=n.useState(null),[L,U]=n.useState(""),A=n.useMemo(()=>(b.sealEvents||[]).find(e=>e.id===j),[b.sealEvents,j]),setInviteeStatus=(e,t)=>{if(!A)return;N(a=>({...a,sealEvents:a.sealEvents.map(a=>a.id===A.id?{...a,invitees:(a.invitees||[]).map((a,s)=>s===e?{...a,status:t}:a),lastUpdate:Date.now()}:a)}));const s=(A.invitees||[]).map((a,s)=>s===e?{...a,status:t}:a);a({type:"event.patch",path:`/v1/events/${A.id}`,body:{invitees:s}})};return n.useEffect(()=>(E.current=new BroadcastChannel(`seal-${j}`),E.current.onmessage=e=>{"update"===(null==e?void 0:e.type)&&N(e=>({...e}))},()=>{var e;return null==(e=E.current)?void 0:e.close()}),[j,N]),n.useEffect(()=>{var e;null==(e=E.current)||e.postMessage({type:"update",at:Date.now()})},[null==A?void 0:A.lastUpdate]),n.useEffect(()=>{(null==A?void 0:A.shareUrl)?l.toDataURL(A.shareUrl).then(U).catch(()=>U("")):U("")},[null==A?void 0:A.shareUrl]),n.useEffect(()=>{var e;let t=null;return"location"===(null==A?void 0:A.shareLevel)&&(null==(e=null==b?void 0:b.profile)?void 0:e.consentGPS)&&(t=navigator.geolocation.watchPosition(e=>{C({lat:e.coords.latitude,lng:e.coords.longitude,accuracy:e.coords.accuracy,at:Date.now()})},()=>{},{enableHighAccuracy:!0,maximumAge:5e3,timeout:1e4})),()=>{null!=t&&navigator.geolocation.clearWatch(t)}},[null==A?void 0:A.shareLevel,null==(g=null==b?void 0:b.profile)?void 0:g.consentGPS]),t.jsx("div",{className:"max-w-3xl mx-auto p-6",children:t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 space-y-4",children:[!A&&t.jsxs("div",{children:[t.jsx(r,{className:"text-yellow-600 mb-2"}),t.jsx("div",{className:"font-semibold mb-2",children:"Event not found"}),t.jsx(i,{to:"/follow-me-home",className:"text-primary-600",children:"Create a new event"})]}),A&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-500",children:"LifeSync Seal Link"}),t.jsx("h1",{className:"text-2xl font-bold",children:A.title})]}),t.jsx(d,{className:"text-primary-600"})]}),t.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-700 rounded flex items-center justify-between",children:[t.jsx("div",{className:"truncate mr-2 text-sm",children:A.shareUrl}),t.jsxs("button",{onClick:async()=>{try{if(!(null==A?void 0:A.shareUrl))return;await navigator.clipboard.writeText(A.shareUrl),w(!0),setTimeout(()=>w(!1),1200)}catch(e){}},className:"px-2 py-1 bg-primary-600 text-white rounded flex items-center text-sm",children:[t.jsx(c,{className:"h-4 w-4 mr-1"})," ",f?"Copied":"Copy"]})]}),L&&t.jsxs("div",{className:"flex items-center gap-4 p-3 bg-white dark:bg-gray-800 rounded border",children:[t.jsx("img",{src:L,alt:"Seal share QR",className:"w-28 h-28"}),t.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:["Scan to open this LifeSync Seal link on a phone.",t.jsx("div",{children:t.jsx("a",{href:L,download:`lifesync-seal-${A.id}.png`,className:"inline-block mt-2 px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded",children:"Download QR"})})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:["active"!==A.status&&t.jsx("button",{onClick:()=>{A&&(N(e=>({...e,sealEvents:e.sealEvents.map(e=>e.id===A.id?{...e,status:"active",startAt:Date.now(),lastUpdate:Date.now()}:e)})),a({type:"event.status",path:`/v1/events/${A.id}/status`,body:{status:"active",timestamp:Date.now()}}))},className:"px-3 py-2 bg-green-600 text-white rounded",children:"Start"}),"active"===A.status&&t.jsx("button",{onClick:()=>{A&&(N(e=>({...e,sealEvents:e.sealEvents.map(e=>e.id===A.id?{...e,status:"ended",endAt:Date.now(),lastUpdate:Date.now()}:e)})),a({type:"event.status",path:`/v1/events/${A.id}/status`,body:{status:"ended",timestamp:Date.now()}}))},className:"px-3 py-2 bg-red-600 text-white rounded",children:"End"}),t.jsxs("button",{onClick:()=>{A&&N(e=>({...e,sealEvents:e.sealEvents.map(e=>e.id===A.id?{...e,mode:"group"===e.mode?"solo":"group",lastUpdate:Date.now()}:e)}))},className:"px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded",children:["Mode: ",A.mode]}),t.jsxs("button",{onClick:()=>{if(!A)return;const e="availability"===A.shareLevel?"location":"availability";N(t=>({...t,sealEvents:t.sealEvents.map(t=>t.id===A.id?{...t,shareLevel:e,lastUpdate:Date.now()}:t)})),a({type:"event.patch",path:`/v1/events/${A.id}`,body:{shareLevel:e}})},className:"px-3 py-2 bg-gray-200 dark:bg-gray-700 rounded",children:["Share: ",A.shareLevel]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-700 rounded",children:[t.jsxs("div",{className:"font-semibold mb-1 flex items-center",children:[t.jsx(o,{className:"h-4 w-4 mr-1"}),"Invitees"]}),t.jsxs("div",{className:"flex gap-2 mb-2",children:[t.jsx("input",{className:"flex-1 p-2 rounded bg-white dark:bg-gray-800",placeholder:"Name",value:k.name,onChange:e=>S({...k,name:e.target.value})}),t.jsx("input",{className:"flex-1 p-2 rounded bg-white dark:bg-gray-800",placeholder:"Contact (email/phone)",value:k.contact,onChange:e=>S({...k,contact:e.target.value})}),t.jsxs("button",{onClick:()=>{A&&k.name&&k.contact&&(N(e=>({...e,sealEvents:e.sealEvents.map(e=>e.id===A.id?{...e,invitees:[...e.invitees||[],{name:k.name,contact:k.contact,status:"pending"}],lastUpdate:Date.now()}:e)})),S({name:"",contact:""}),a({type:"event.patch",path:`/v1/events/${A.id}`,body:{invitees:[...A.invitees||[],{name:k.name,contact:k.contact,status:"pending"}]}}))},className:"px-2 py-1 bg-primary-600 text-white rounded text-sm flex items-center",children:[t.jsx(m,{className:"h-4 w-4 mr-1"}),"Add"]})]}),t.jsxs("ul",{className:"text-sm space-y-1",children:[(A.invitees||[]).map((e,s)=>t.jsxs("li",{className:"flex items-center justify-between gap-2",children:[t.jsxs("span",{className:"truncate",children:[e.name," — ",e.contact]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-xs mr-2",children:e.status||"pending"}),t.jsx("button",{onClick:()=>setInviteeStatus(s,"accepted"),title:"Accept",className:"px-1.5 py-1 bg-green-600 text-white rounded text-xs",children:t.jsx(x,{className:"h-3 w-3"})}),t.jsx("button",{onClick:()=>setInviteeStatus(s,"declined"),title:"Decline",className:"px-1.5 py-1 bg-yellow-600 text-white rounded text-xs",children:t.jsx(v,{className:"h-3 w-3"})}),t.jsx("button",{onClick:()=>(e=>{A&&(N(t=>({...t,sealEvents:t.sealEvents.map(t=>t.id===A.id?{...t,invitees:(t.invitees||[]).filter((t,a)=>a!==e),lastUpdate:Date.now()}:t)})),a({type:"event.patch",path:`/v1/events/${A.id}`,body:{invitees:(A.invitees||[]).filter((t,a)=>a!==e)}}))})(s),title:"Remove",className:"px-1.5 py-1 bg-red-600 text-white rounded text-xs",children:t.jsx(u,{className:"h-3 w-3"})})]})]},s)),(!A.invitees||0===A.invitees.length)&&t.jsx("li",{className:"text-gray-500",children:"No invitees added"})]})]}),t.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-700 rounded",children:[t.jsxs("div",{className:"font-semibold mb-1 flex items-center",children:[t.jsx(h,{className:"h-4 w-4 mr-1"}),"Status"]}),t.jsx("div",{className:"text-sm",children:A.status}),t.jsxs("div",{className:"text-sm",children:["Started: ",A.startAt?new Date(A.startAt).toLocaleString():"-"]}),t.jsxs("div",{className:"text-sm",children:["Ended: ",A.endAt?new Date(A.endAt).toLocaleString():"-"]})]})]}),t.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-700 rounded",children:[t.jsxs("div",{className:"font-semibold mb-2 flex items-center",children:[t.jsx(p,{className:"h-4 w-4 mr-1"}),"Location Sharing"]}),t.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:"availability"===A.shareLevel?"Sharing availability/commitment status only.":"Sharing real-time location to invitees."}),"location"===A.shareLevel&&t.jsx("div",{className:"mt-2 text-xs",children:(null==(y=null==b?void 0:b.profile)?void 0:y.consentGPS)?D?t.jsxs("div",{children:["Current: lat ",D.lat.toFixed(5),", lng ",D.lng.toFixed(5)," (±",Math.round(D.accuracy),"m) — ",new Date(D.at).toLocaleTimeString()]}):t.jsx("div",{children:"Waiting for GPS…"}):t.jsx("div",{className:"text-red-600",children:"GPS consent is required for location sharing."})})]})]})]})})};export{SealEvent as default};
