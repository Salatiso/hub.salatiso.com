<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinHelp | The Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
        #app-container { visibility: hidden; }
        .workspace-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
        /* Simple styling for inputs */
        .input {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors;
        }
        .btn-secondary {
            @apply bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors;
        }
    </style>
</head>
<body class="bg-slate-100" data-module="finhelp">
    <div id="app-container" class="flex h-screen bg-slate-100">
        <!-- Sidebar will be injected here -->
        <div id="sidebar-placeholder"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header will be injected here -->
            <div id="header-placeholder"></div>

            <!-- Main Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Workspace Switcher -->
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900">Finance Help</h1>
                            <p class="mt-1 text-slate-600">Manage your personal and business finances in one place.</p>
                        </div>
                        <div class="mt-4 sm:mt-0">
                            <div class="flex items-center bg-slate-200 p-1 rounded-lg text-sm">
                                <button id="workspace-personal-btn" class="workspace-button active w-1/2 text-center px-4 py-2 rounded-md font-semibold transition-colors">Personal</button>
                                <button id="workspace-business-btn" class="workspace-button w-1/2 text-center px-4 py-2 rounded-md font-semibold text-slate-600 transition-colors">Business</button>
                            </div>
                        </div>
                    </div>

                    <!-- Workspaces -->
                    <div id="personal-workspace">
                        <!-- Personal finance module will be injected here by finhelp-personal.js -->
                        <p class="text-center text-slate-500 py-10">Loading Personal Finance Hub...</p>
                    </div>
                    <div id="business-workspace" class="hidden">
                        <!-- Business finance module will be injected here by finhelp-business.js -->
                         <p class="text-center text-slate-500 py-10">Loading Business Finance Hub...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

<!-- Place at the bottom of <body> in training.html, dashboard.html, etc. -->

    <!-- Your Core App Scripts -->
    <script type="module" src="../assets/js/firebase-config.js"></script>
    <script type="module" src="../assets/js/app.js"></script>

    <!-- Page-specific script (if needed) -->
    <script type="module" src="../assets/js/modules/finhelp.js"></script>
</body>
</html>
import { getDocument, updateDocument, addDocument, saveDocument, deleteDocument } from '../database.js';
import { auth } from '../firebase-config.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

let currentUser = null;
let currentWorkspace = 'personal';
let userFinancialData = {};

export async function init(user) {
    currentUser = user;
    console.log('FinHelp module initializing for user:', user.uid);
    
    // Load user's financial data
    await loadUserFinancialData();
    
    // Setup workspace switching
    setupWorkspaceSwitching();
    
    // Initialize the current workspace
    await renderWorkspace();
}

async function loadUserFinancialData() {
    try {
        const data = await getDocument('userFinances', currentUser.uid);
        userFinancialData = data || {
            personal: {
                income: [],
                expenses: [],
                assets: [],
                liabilities: [],
                insurances: [],
                savingsGoals: [],
                taxHistory: [],
                creditProfile: {}
            },
            business: {
                income: [],
                expenses: [],
                assets: [],
                liabilities: [],
                insurances: [],
                taxHistory: []
            },
            settings: {
                currency: 'ZAR',
                taxYear: new Date().getFullYear(),
                riskProfile: 'moderate'
            }
        };
    } catch (error) {
        console.error('Error loading financial data:', error);
        userFinancialData = getDefaultFinancialData();
    }
}

function getDefaultFinancialData() {
    return {
        personal: {
            income: [],
            expenses: [],
            assets: [],
            liabilities: [],
            insurances: [],
            savingsGoals: [],
            taxHistory: [],
            creditProfile: {}
        },
        business: {
            income: [],
            expenses: [],
            assets: [],
            liabilities: [],
            insurances: [],
            taxHistory: []
        },
        settings: {
            currency: 'ZAR',
            taxYear: new Date().getFullYear(),
            riskProfile: 'moderate'
        }
    };
}

function setupWorkspaceSwitching() {
    document.getElementById('workspace-personal-btn').addEventListener('click', () => switchWorkspace('personal'));
    document.getElementById('workspace-business-btn').addEventListener('click', () => switchWorkspace('business'));
}

async function switchWorkspace(workspace) {
    currentWorkspace = workspace;
    
    // Update button states
    document.querySelectorAll('.workspace-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-slate-600');
    });
    
    const activeBtn = document.getElementById(`workspace-${workspace}-btn`);
    activeBtn.classList.add('active');
    activeBtn.classList.remove('text-slate-600');
    
    // Render the workspace
    await renderWorkspace();
}

async function renderWorkspace() {
    const personalWorkspace = document.getElementById('personal-workspace');
    const businessWorkspace = document.getElementById('business-workspace');
    
    if (currentWorkspace === 'personal') {
        personalWorkspace.classList.remove('hidden');
        businessWorkspace.classList.add('hidden');
        await renderPersonalFinanceHub();
    } else {
        personalWorkspace.classList.add('hidden');
        businessWorkspace.classList.remove('hidden');
        await renderBusinessFinanceHub();
    }
}

async function renderPersonalFinanceHub() {
    const container = document.getElementById('personal-workspace');
    
    container.innerHTML = `
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-slate-200">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button class="tab-button active py-4 px-1 border-b-2 font-medium text-sm" data-tab="overview">
                        <i class="fas fa-chart-line mr-2"></i>Overview
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="documents">
                        <i class="fas fa-file-upload mr-2"></i>Documents
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="budgeting">
                        <i class="fas fa-wallet mr-2"></i>Budgeting
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="insurance">
                        <i class="fas fa-shield-alt mr-2"></i>Insurance
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="savings">
                        <i class="fas fa-piggy-bank mr-2"></i>Savings Goals
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="tax">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>Tax Management
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="calculators">
                        <i class="fas fa-calculator mr-2"></i>Calculators
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="credit">
                        <i class="fas fa-credit-card mr-2"></i>Credit Profile
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-slate-500 hover:text-slate-700" data-tab="kids">
                        <i class="fas fa-child mr-2"></i>Kids Dashboard
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content" class="bg-white rounded-lg shadow-sm p-6">
            <!-- Content will be rendered here -->
        </div>
    `;
    
    // Setup tab switching
    setupTabSwitching();
    
    // Render initial tab
    await renderTabContent('overview');
}

function setupTabSwitching() {
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', async (e) => {
            const tabName = e.target.closest('.tab-button').dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-slate-500');
            });
            
            e.target.closest('.tab-button').classList.add('active');
            e.target.closest('.tab-button').classList.remove('text-slate-500');
            
            // Render tab content
            await renderTabContent(tabName);
        });
    });
}

async function renderTabContent(tabName) {
    const container = document.getElementById('tab-content');
    
    switch (tabName) {
        case 'overview':
            await renderOverviewTab(container);
            break;
        case 'documents':
            await renderDocumentsTab(container);
            break;
        case 'budgeting':
            await renderBudgetingTab(container);
            break;
        case 'insurance':
            await renderInsuranceTab(container);
            break;
        case 'savings':
            await renderSavingsGoalsTab(container);
            break;
        case 'tax':
            await renderTaxManagementTab(container);
            break;
        case 'calculators':
            await renderCalculatorsTab(container);
            break;
        case 'credit':
            await renderCreditProfileTab(container);
            break;
        case 'kids':
            await renderKidsDashboardTab(container);
            break;
        default:
            container.innerHTML = '<p>Tab content coming soon...</p>';
    }
}

async function renderOverviewTab(container) {
    const personalData = userFinancialData.personal;
    
    // Calculate summary statistics
    const totalIncome = personalData.income.reduce((sum, item) => sum + (item.monthlyAmount || 0), 0);
    const totalExpenses = personalData.expenses.reduce((sum, item) => sum + (item.monthlyAmount || 0), 0);
    const totalAssets = personalData.assets.reduce((sum, item) => sum + (item.currentValue || 0), 0);
    const totalLiabilities = personalData.liabilities.reduce((sum, item) => sum + (item.currentBalance || 0), 0);
    const netWorth = totalAssets - totalLiabilities;
    const monthlySavings = totalIncome - totalExpenses;
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Financial Summary Cards -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">Monthly Income</p>
                        <p class="text-2xl font-bold">R${totalIncome.toLocaleString()}</p>
                    </div>
                    <i class="fas fa-arrow-up text-3xl text-green-200"></i>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm">Monthly Expenses</p>
                        <p class="text-2xl font-bold">R${totalExpenses.toLocaleString()}</p>
                    </div>
                    <i class="fas fa-arrow-down text-3xl text-red-200"></i>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Net Worth</p>
                        <p class="text-2xl font-bold">R${netWorth.toLocaleString()}</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-blue-200"></i>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Monthly Savings</p>
                        <p class="text-2xl font-bold">R${monthlySavings.toLocaleString()}</p>
                    </div>
                    <i class="fas fa-piggy-bank text-3xl text-purple-200"></i>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors cursor-pointer" onclick="switchToTab('documents')">
                <i class="fas fa-upload text-3xl text-slate-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-slate-700">Upload Financial Documents</h3>
                <p class="text-slate-500 text-sm">Bank statements, payslips, insurance docs</p>
            </div>
            
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors cursor-pointer" onclick="switchToTab('savings')">
                <i class="fas fa-target text-3xl text-slate-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-slate-700">Set Savings Goal</h3>
                <p class="text-slate-500 text-sm">Track progress towards your financial goals</p>
            </div>
            
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors cursor-pointer" onclick="switchToTab('calculators')">
                <i class="fas fa-calculator text-3xl text-slate-400 mb-4"></i>
                <h3 class="text-lg font-semibent text-slate-700">Financial Calculators</h3>
                <p class="text-slate-500 text-sm">Loan affordability, retirement planning</p>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-slate-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">Recent Financial Activity</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-plus text-green-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-slate-900">Salary Deposit</p>
                            <p class="text-xs text-slate-500">2 days ago</p>
                        </div>
                    </div>
                    <span class="text-green-600 font-semibold">+R15,000</span>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-minus text-red-600"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-slate-900">Grocery Shopping</p>
                            <p class="text-xs text-slate-500">3 days ago</p>
                        </div>
                    </div>
                    <span class="text-red-600 font-semibold">-R1,200</span>
                </div>
            </div>
        </div>
    `;
}

async function renderDocumentsTab(container) {
    container.innerHTML = `
        <div class="space-y-6">
            <!-- Document Upload Section -->
            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-slate-900 mb-4">
                    <i class="fas fa-file-upload mr-2 text-indigo-600"></i>
                    Upload Financial Documents
                </h3>
                <p class="text-slate-600 mb-6">Upload bank statements, payslips, insurance documents, and more. Our system will automatically extract relevant information for you to review and approve.</p>
                
                <!-- Upload Area -->
                <div class="border-2 border-dashed border-indigo-300 rounded-lg p-8 text-center mb-6">
                    <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-4"></i>
                    <h4 class="text-lg font-medium text-slate-700 mb-2">Drag & Drop Files or Click to Browse</h4>
                    <p class="text-slate-500 mb-4">Supports: PDF, PNG, JPG, CSV, Excel files</p>
                    <input type="file" id="document-upload" multiple accept=".pdf,.png,.jpg,.jpeg,.csv,.xlsx,.xls" class="hidden">
                    <button onclick="document.getElementById('document-upload').click()" class="btn-primary">
                        <i class="fas fa-upload mr-2"></i>Choose Files
                    </button>
                </div>

                <!-- Quick Input Options -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg p-4 border border-slate-200">
                        <h4 class="font-medium text-slate-900 mb-2">
                            <i class="fas fa-sms mr-2 text-green-600"></i>Bank SMS Messages
                        </h4>
                        <p class="text-sm text-slate-600 mb-3">Paste your bank SMS notifications here</p>
                        <textarea id="sms-input" rows="4" class="input w-full" placeholder="Paste bank SMS messages here..."></textarea>
                        <button onclick="processBankSMS()" class="btn-primary mt-2 w-full">
                            <i class="fas fa-magic mr-2"></i>Extract Information
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4 border border-slate-200">
                        <h4 class="font-medium text-slate-900 mb-2">
                            <i class="fas fa-copy mr-2 text-blue-600"></i>Copy & Paste Documents
                        </h4>
                        <p class="text-sm text-slate-600 mb-3">Copy text from PDFs or other documents</p>
                        <textarea id="document-text" rows="4" class="input w-full" placeholder="Paste document text here..."></textarea>
                        <button onclick="processDocumentText()" class="btn-primary mt-2 w-full">
                            <i class="fas fa-search mr-2"></i>Analyze Text
                        </button>
                    </div>
                </div>
            </div>

            <!-- Processed Documents -->
            <div class="bg-white rounded-lg border border-slate-200">
                <div class="px-6 py-4 border-b border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900">
                        <i class="fas fa-folder-open mr-2 text-slate-600"></i>
                        Processed Documents
                    </h3>
                </div>
                <div id="processed-documents" class="p-6">
                    ${renderProcessedDocuments()}
                </div>
            </div>
        </div>
    `;

    // Setup file upload handler
    document.getElementById('document-upload').addEventListener('change', handleFileUpload);
}

function renderProcessedDocuments() {
    if (!userFinancialData.personal.documents || userFinancialData.personal.documents.length === 0) {
        return `
            <div class="text-center py-8">
                <i class="fas fa-file-alt text-4xl text-slate-300 mb-4"></i>
                <p class="text-slate-500">No documents uploaded yet</p>
                <p class="text-sm text-slate-400">Upload your first document to get started</p>
            </div>
        `;
    }

    return userFinancialData.personal.documents.map(doc => `
        <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg mb-3">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-alt text-blue-600"></i>
                </div>
                <div class="ml-3">
                    <h4 class="font-medium text-slate-900">${doc.name}</h4>
                    <p class="text-sm text-slate-500">Uploaded ${doc.uploadDate} • ${doc.extractedItems} items found</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="reviewDocument('${doc.id}')" class="btn-secondary text-sm">
                    <i class="fas fa-eye mr-1"></i>Review
                </button>
                <button onclick="deleteDocument('${doc.id}')" class="btn-secondary text-sm text-red-600">
                    <i class="fas fa-trash mr-1"></i>Delete
                </button>
            </div>
        </div>
    `).join('');
}

async function handleFileUpload(event) {
    const files = event.target.files;
    for (let file of files) {
        await processUploadedFile(file);
    }
}

async function processUploadedFile(file) {
    try {
        // Show processing indicator
        showNotification('Processing document...', 'info');
        
        // Simulate document processing (in real app, would use OCR service)
        const extractedData = await simulateDocumentExtraction(file);
        
        // Store the document
        if (!userFinancialData.personal.documents) {
            userFinancialData.personal.documents = [];
        }
        
        userFinancialData.personal.documents.push({
            id: Date.now().toString(),
            name: file.name,
            type: file.type,
            uploadDate: new Date().toLocaleDateString(),
            extractedItems: extractedData.length,
            data: extractedData
        });
        
        await saveUserFinancialData();
        
        // Refresh the documents display
        await renderTabContent('documents');
        
        showNotification(`Document processed successfully! Found ${extractedData.length} financial items.`, 'success');
        
    } catch (error) {
        console.error('Error processing document:', error);
        showNotification('Error processing document. Please try again.', 'error');
    }
}

async function simulateDocumentExtraction(file) {
    // Simulate document processing delay
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Return simulated extracted data based on file type
    if (file.name.toLowerCase().includes('bank') || file.name.toLowerCase().includes('statement')) {
        return [
            { type: 'transaction', date: '2024-01-15', description: 'Salary Deposit', amount: 15000, category: 'Income' },
            { type: 'transaction', date: '2024-01-14', description: 'Grocery Store', amount: -1200, category: 'Food' },
            { type: 'transaction', date: '2024-01-13', description: 'Fuel Station', amount: -800, category: 'Transport' }
        ];
    } else if (file.name.toLowerCase().includes('payslip')) {
        return [
            { type: 'income', source: 'Salary', monthlyAmount: 15000, taxDeducted: 2250 }
        ];
    } else if (file.name.toLowerCase().includes('insurance')) {
        return [
            { type: 'insurance', provider: 'ABC Insurance', policyType: 'Car Insurance', monthlyPremium: 1200, coverageAmount: 300000 }
        ];
    }
    
    return [];
}

async function processBankSMS() {
    const smsText = document.getElementById('sms-input').value;
    if (!smsText.trim()) {
        showNotification('Please enter bank SMS messages', 'warning');
        return;
    }

    try {
        showNotification('Processing SMS messages...', 'info');
        
        // Parse SMS messages (simple pattern matching)
        const transactions = parseBankSMS(smsText);
        
        if (transactions.length > 0) {
            // Add to user's financial data
            userFinancialData.personal.transactions = userFinancialData.personal.transactions || [];
            userFinancialData.personal.transactions.push(...transactions);
            
            await saveUserFinancialData();
            
            showNotification(`Extracted ${transactions.length} transactions from SMS messages`, 'success');
            
            // Clear the input
            document.getElementById('sms-input').value = '';
        } else {
            showNotification('No transactions found in SMS messages', 'warning');
        }
        
    } catch (error) {
        console.error('Error processing SMS:', error);
        showNotification('Error processing SMS messages', 'error');
    }
}

function parseBankSMS(smsText) {
    const transactions = [];
    const lines = smsText.split('\n');
    
    lines.forEach(line => {
        // Simple pattern matching for common SMS formats
        // Example: "You have spent R1200.00 at GROCERY STORE on 15/01/2024"
        const spentMatch = line.match(/spent R?([\d,]+\.?\d*) at (.+?) on (\d{2}\/\d{2}\/\d{4})/i);
        if (spentMatch) {
            transactions.push({
                type: 'expense',
                amount: -parseFloat(spentMatch[1].replace(',', '')),
                description: spentMatch[2].trim(),
                date: spentMatch[3],
                source: 'Bank SMS'
            });
        }
        
        // Example: "You have received R15000.00 salary on 15/01/2024"
        const receivedMatch = line.match(/received R?([\d,]+\.?\d*) (.+?) on (\d{2}\/\d{2}\/\d{4})/i);
        if (receivedMatch) {
            transactions.push({
                type: 'income',
                amount: parseFloat(receivedMatch[1].replace(',', '')),
                description: receivedMatch[2].trim(),
                date: receivedMatch[3],
                source: 'Bank SMS'
            });
        }
    });
    
    return transactions;
}

async function processDocumentText() {
    const documentText = document.getElementById('document-text').value;
    if (!documentText.trim()) {
        showNotification('Please paste document text', 'warning');
        return;
    }

    try {
        showNotification('Analyzing document text...', 'info');
        
        // Simple text analysis for financial information
        const extractedData = analyzeDocumentText(documentText);
        
        if (extractedData.length > 0) {
            // Show review modal for extracted data
            showDataReviewModal(extractedData);
        } else {
            showNotification('No financial information found in the text', 'warning');
        }
        
    } catch (error) {
        console.error('Error analyzing text:', error);
        showNotification('Error analyzing document text', 'error');
    }
}

function analyzeDocumentText(text) {
    const extractedData = [];
    
    // Look for currency amounts
    const amountMatches = text.match(/R\s?[\d,]+\.?\d*/g);
    if (amountMatches) {
        amountMatches.forEach(match => {
            const amount = parseFloat(match.replace(/[R,\s]/g, ''));
            if (amount > 0) {
                extractedData.push({
                    type: 'amount',
                    value: amount,
                    context: getAmountContext(text, match)
                });
            }
        });
    }
    
    // Look for dates
    const dateMatches = text.match(/\d{1,2}\/\d{1,2}\/\d{4}/g);
    if (dateMatches) {
        extractedData.push({
            type: 'dates',
            values: dateMatches
        });
    }
    
    return extractedData;
}

function getAmountContext(text, amount) {
    const index = text.indexOf(amount);
    const start = Math.max(0, index - 50);
    const end = Math.min(text.length, index + amount.length + 50);
    return text.substring(start, end);
}

async function renderInsuranceTab(container) {
    const insuranceData = userFinancialData.personal.insurances || [];
    
    container.innerHTML = `
        <div class="space-y-6">
            <!-- Insurance Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Total Monthly Premiums</p>
                            <p class="text-2xl font-bold">R${insuranceData.reduce((sum, ins) => sum + (ins.monthlyPremium || 0), 0).toLocaleString()}</p>
                        </div>
                        <i class="fas fa-shield-alt text-3xl text-green-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Total Coverage</p>
                            <p class="text-2xl font-bold">R${insuranceData.reduce((sum, ins) => sum + (ins.coverageAmount || 0), 0).toLocaleString()}</p>
                        </div>
                        <i class="fas fa-umbrella text-3xl text-blue-200"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Active Policies</p>
                            <p class="text-2xl font-bold">${insuranceData.length}</p>
                        </div>
                        <i class="fas fa-file-contract text-3xl text-purple-200"></i>
                    </div>
                </div>
            </div>

            <!-- Add Insurance Button -->
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-slate-900">Insurance Policies</h3>
                <button onclick="openAddInsuranceModal()" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Add Insurance Policy
                </button>
            </div>

            <!-- Insurance List -->
            <div class="bg-white rounded-lg border border-slate-200">
                <div id="insurance-list">
                    ${renderInsuranceList(insuranceData)}
                </div>
            </div>

            <!-- Insurance Intelligence -->
            <div class="bg-blue-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-blue-900 mb-4">
                    <i class="fas fa-brain mr-2"></i>Insurance Intelligence
                </h3>
                ${renderInsuranceAdvice(insuranceData)}
            </div>
        </div>

        <!-- Add Insurance Modal -->
        <div id="add-insurance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-90vh overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Add Insurance Policy</h3>
                    <button onclick="closeAddInsuranceModal()" class="text-slate-400 hover:text-slate-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="insurance-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Insurance Type</label>
                            <select id="insurance-type" class="input" required>
                                <option value="">Select type...</option>
                                <option value="car">Car Insurance</option>
                                <option value="home">Home Insurance</option>
                                <option value="life">Life Insurance</option>
                                <option value="health">Health Insurance</option>
                                <option value="disability">Disability Insurance</option>
                                <option value="travel">Travel Insurance</option>
                                <option value="business">Business Insurance</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Insurance Provider</label>
                            <input type="text" id="insurance-provider" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Policy Number</label>
                            <input type="text" id="policy-number" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Monthly Premium (R)</label>
                            <input type="number" id="monthly-premium" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Coverage Amount (R)</label>
                            <input type="number" id="coverage-amount" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                            <input type="date" id="start-date" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Renewal Date</label>
                            <input type="date" id="renewal-date" class="input" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Excess Amount (R)</label>
                            <input type="number" id="excess-amount" class="input">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                        <textarea id="insurance-notes" rows="3" class="input"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddInsuranceModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Add Insurance Policy</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    // Setup form submission
    document.getElementById('insurance-form').addEventListener('submit', handleAddInsurance);
}

function renderInsuranceList(insuranceData) {
    if (insuranceData.length === 0) {
        return `
            <div class="p-8 text-center">
                <i class="fas fa-shield-alt text-4xl text-slate-300 mb-4"></i>
                <p class="text-slate-500">No insurance policies added yet</p>
                <p class="text-sm text-slate-400">Add your first policy to start tracking</p>
            </div>
        `;
    }

    return insuranceData.map(insurance => `
        <div class="border-b border-slate-200 last:border-b-0 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <h4 class="font-semibold text-slate-900">${insurance.type} - ${insurance.provider}</h4>
                        <p class="text-sm text-slate-600">Policy: ${insurance.policyNumber}</p>
                        <p class="text-xs text-slate-500">Renews: ${insurance.renewalDate}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-semibold text-slate-900">R${insurance.monthlyPremium}/month</p>
                    <p class="text-sm text-slate-600">Coverage: R${insurance.coverageAmount.toLocaleString()}</p>
                    <div class="flex items-center space-x-2 mt-2">
                        <button onclick="editInsurance('${insurance.id}')" class="btn-secondary text-xs">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="deleteInsurance('${insurance.id}')" class="btn-secondary text-xs text-red-600">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderInsuranceAdvice(insuranceData) {
    const advice = [];
    
    // Check for upcoming renewals
    const upcoming = insuranceData.filter(ins => {
        const renewalDate = new Date(ins.renewalDate);
        const now = new Date();
        const diffTime = renewalDate.getTime() - now.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays <= 30 && diffDays > 0;
    });
    
    if (upcoming.length > 0) {
        advice.push(`
            <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-yellow-800 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Renewal Reminders
                </h4>
                <p class="text-yellow-700">You have ${upcoming.length} insurance policies renewing in the next 30 days. Consider reviewing rates and coverage.</p>
            </div>
        `);
    }
    
    // Check coverage gaps
    const hasLife = insuranceData.some(ins => ins.type === 'life');
    const hasDisability = insuranceData.some(ins => ins.type === 'disability');
    
    if (!hasLife) {
        advice.push(`
            <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-red-800 mb-2">
                    <i class="fas fa-heart mr-2"></i>Life Insurance Gap
                </h4>
                <p class="text-red-700">Consider adding life insurance to protect your family's financial future.</p>
            </div>
        `);
    }
    
    if (!hasDisability) {
        advice.push(`
            <div class="bg-orange-100 border border-orange-300 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-orange-800 mb-2">
                    <i class="fas fa-wheelchair mr-2"></i>Disability Insurance
                </h4>
                <p class="text-orange-700">Disability insurance can protect your income if you're unable to work.</p>
            </div>
        `);
    }
    
    if (advice.length === 0) {
        advice.push(`
            <div class="bg-green-100 border border-green-300 rounded-lg p-4">
                <h4 class="font-medium text-green-800 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>Good Coverage
                </h4>
                <p class="text-green-700">Your insurance portfolio looks well-balanced. Keep monitoring for any changes in your life circumstances.</p>
            </div>
        `);
    }
    
    return advice.join('');
}

// Continue with savings goals, tax management, and other features...
// [The implementation continues with the remaining tabs and functionality]

// Firebase initialization
document.addEventListener('firebase-ready', () => {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            init(user);
        }
    });
});

// Direct auth state change listener
onAuthStateChanged(auth, (user) => {
    if (user) {
        init(user);
    }
});

// Helper functions
async function saveUserFinancialData() {
    try {
        await saveDocument('userFinances', currentUser.uid, userFinancialData);
    } catch (error) {
        console.error('Error saving financial data:', error);
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function switchToTab(tabName) {
    // Find and click the tab button
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (tabButton) {
        tabButton.click();
    }
}

// Export public functions
window.openAddInsuranceModal = function() {
    document.getElementById('add-insurance-modal').classList.remove('hidden');
};

window.closeAddInsuranceModal = function() {
    document.getElementById('add-insurance-modal').classList.add('hidden');
    document.getElementById('insurance-form').reset();
};

window.handleAddInsurance = async function(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const insuranceData = {
        id: Date.now().toString(),
        type: document.getElementById('insurance-type').value,
        provider: document.getElementById('insurance-provider').value,
        policyNumber: document.getElementById('policy-number').value,
        monthlyPremium: parseFloat(document.getElementById('monthly-premium').value),
        coverageAmount: parseFloat(document.getElementById('coverage-amount').value),
        startDate: document.getElementById('start-date').value,
        renewalDate: document.getElementById('renewal-date').value,
        excessAmount: parseFloat(document.getElementById('excess-amount').value) || 0,
        notes: document.getElementById('insurance-notes').value,
        addedDate: new Date().toISOString()
    };
    
    try {
        if (!userFinancialData.personal.insurances) {
            userFinancialData.personal.insurances = [];
        }
        
        userFinancialData.personal.insurances.push(insuranceData);
        await saveUserFinancialData();
        
        closeAddInsuranceModal();
        await renderTabContent('insurance');
        
        showNotification('Insurance policy added successfully!', 'success');
    } catch (error) {
        console.error('Error adding insurance:', error);
        showNotification('Error adding insurance policy', 'error');
    }
};